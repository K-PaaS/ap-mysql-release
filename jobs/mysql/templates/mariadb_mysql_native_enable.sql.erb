<%
  if p('cf_mysql.mysql.remote_admin_access')
    hosts = ['%']
  else
    hosts = %w{localhost 127.0.0.1 ::1}
  end
  quoted_hosts_string = hosts.map {|host| "'#{host}'"}.join(', ')
%>


CREATE FUNCTION IF NOT EXISTS ed25519_password RETURNS STRING SONAME "auth_ed25519.so";

<% hosts.each do |host| %>
UPDATE mysql.user SET password = '', plugin = 'mysql_native_password', authentication_string = password('<%= p('cf_mysql.mysql.admin_password') %>') where user = '<%= p('cf_mysql.mysql.admin_username') %>' and host = '<%= host %>';
	<% if p('cf_mysql.mysql.roadmin_enabled') %>
	UPDATE mysql.user SET password = '', plugin = 'mysql_native_password', authentication_string = password('<%= p('cf_mysql.mysql.roadmin_password') %>') where user = 'roadmin' and host = '<%= host %>';  
	<% end %>
<% end %>

GRANT USAGE ON mysql.* TO 'cluster-health-logger'@'127.0.0.1' IDENTIFIED BY '<%= p('cf_mysql.mysql.cluster_health.password') %>';
UPDATE mysql.user SET password = '', plugin = 'mysql_native_password', authentication_string = password('<%= p('cf_mysql.mysql.cluster_health.password') %>') where user = 'cluster-health-logger' and host = '127.0.0.1';

GRANT USAGE ON mysql.* TO 'galera-healthcheck'@'127.0.0.1' IDENTIFIED BY '<%= p('cf_mysql.mysql.galera_healthcheck.db_password') %>';
UPDATE mysql.user SET password = '', plugin = 'mysql_native_password', authentication_string = password('<%= p('cf_mysql.mysql.galera_healthcheck.db_password') %>') where user = 'galera-healthcheck' and host = '127.0.0.1';

DROP USER IF EXISTS 'smoke-tests'@'%';

FLUSH PRIVILEGES;
